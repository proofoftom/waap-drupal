(function(c,r,l){"use strict";var h=!1;r.behaviors.walletAuth={connector:null,state:"idle",csrfToken:null,buttonText:"Sign In",attach:function(t,e){!h&&c(t).is(document)&&(h=!0,this.init(t,e))},init:function(t,e){var n=this,s=c,i=e.walletAuth||{},o=i.waapConfig||{};o.projectName=i.projectName||"",o.projectLogo=i.projectLogo||"",o.projectEntryTitle=i.projectEntryTitle||"",o.walletConnectProjectId=i.walletConnectProjectId||"",this.connector=new r.walletAuth.WalletConnector(o),this.buttonText=i.buttonText||"Sign In";var u=s(".wallet-auth-login-btn",t);u.on("click",function(a){a.preventDefault(),n.handleSignIn()}),this.connector.init().then(function(){n.setState("idle"),n.updateUI()}).catch(function(a){console.error("Initialization error:",a),n.setState("error"),n.showError("Failed to initialize wallet connection")})},handleSignIn:function(){var t=this;this.setState("signing"),this.updateUI(),this.connector.checkSession().then(function(e){return e?(console.log("Using existing wallet session:",e),e):t.connector.login().then(function(n){if(!n)throw{cancelled:!0};return console.log("Logged in via:",n),t.connector.getAddress()})}).then(function(e){return t.performAuthentication(e)}).catch(function(e){if(e&&e.cancelled){t.setState("idle"),t.updateUI();return}console.error("Sign-in error:",e),e.message&&e.message.includes("User rejected")||e.message&&e.message.includes("user rejected")||e.code===4001?(t.setState("idle"),t.updateUI(),t.showError("Signature request was cancelled. Please try again.")):(t.setState("error"),t.updateUI(),t.showError(e.message||"Sign-in failed"))})},performAuthentication:function(t){var e=this;return this.fetchNonce(t).then(function(n){var s=n.nonce;e.connector.lastNonce=s,e.csrfToken=n.csrf_token;var i=e.createSignMessage(t,s);return e.connector.signMessage(i).then(function(o){return{signature:o,message:i,nonce:s}})}).then(function(n){return e.sendAuthentication(t,n.signature,n.message,n.nonce)}).then(function(n){if(n.success)e.setState("authenticated"),e.showSuccess("Signed in as "+n.username),l.walletAuth.redirectOnSuccess?window.location.href=l.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(n.error||"Authentication failed")})},fetchNonce:function(t){var e=l.walletAuth.apiEndpoint;return fetch(e+"/nonce?wallet_address="+t,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(function(n){if(!n.ok)throw new Error("Failed to fetch nonce");return n.json()})},createSignMessage:function(t,e){var n=window.location.hostname,s=window.location.origin,i=new Date().toISOString(),o=new Date(Date.now()+3e5).toISOString(),u=l.walletAuth.chainId||1,a=n+` wants you to sign in with your Ethereum account:
`;return a+=t+`

`,a+=`Sign in with Ethereum to prove ownership of your wallet.

`,a+="URI: "+s+`
`,a+=`Version: 1
`,a+="Chain ID: "+u+`
`,a+="Nonce: "+e+`
`,a+="Issued At: "+i+`
`,a+="Expiration Time: "+o,a},sendAuthentication:function(t,e,n,s){var i=l.walletAuth.apiEndpoint+"/authenticate";return fetch(i,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:t,signature:e,message:n,nonce:s,csrf_token:this.csrfToken})}).then(function(o){return o.ok?o.json():o.json().then(function(u){throw new Error(u.error||"Authentication failed")})})},setState:function(t){this.state=t,c("body").attr("data-wallet-auth-state",t)},updateUI:function(){var t=c,e=t(".wallet-auth-login-btn"),n=t(".wallet-auth-status");switch(this.state){case"idle":e.prop("disabled",!1).find("span").text(this.buttonText),n.text("");break;case"signing":e.prop("disabled",!0).find("span").text("Signing in..."),n.text("Please complete the sign-in in your wallet...");break;case"authenticated":e.prop("disabled",!0).find("span").text("Signed In"),n.text("Authentication successful!");break;case"error":e.prop("disabled",!1).find("span").text("Try Again"),n.text("Sign-in failed. Please try again.");break}},showError:function(t){r.behaviors.walletAuth.showMessage?r.behaviors.walletAuth.showMessage(t,"error"):alert(t)},showSuccess:function(t){r.behaviors.walletAuth.showMessage?r.behaviors.walletAuth.showMessage(t,"status"):console.log(t)},formatAddress:function(t){return t?t.substring(0,6)+"..."+t.substring(t.length-4):""},detach:function(t,e){this.connector&&this.connector.destroy()}},r.behaviors.walletAuth.showMessage=function(t,e){e=typeof e<"u"?e:"status";var n=c,s=n(".messages__wrapper");if(s.length){var i=n('<div class="messages messages--'+e+'">'+t+"</div>");s.append(i),setTimeout(function(){i.fadeOut()},5e3)}}})(jQuery,Drupal,drupalSettings);
