(function(){"use strict";(function(s,a,c){a.behaviors.walletAuth={connector:null,state:"idle",attach:function(t,n){s("body").once("wallet-auth-init").length&&this.init(t,n)},init:function(t,n){const e=this,i=n.walletAuth||{};this.connector=new WalletAuthConnector({authenticationMethods:i.authenticationMethods||["email","social"],allowedSocials:i.allowedSocials||["google","twitter","discord"]}),s(".wallet-auth-login-btn",t).on("click",function(o){o.preventDefault(),e.handleLogin()}),s(".wallet-auth-disconnect-btn",t).on("click",function(o){o.preventDefault(),e.handleDisconnect()}),this.connector.init().then(()=>this.connector.checkSession()).then(o=>{o?(e.setState("connected"),e.updateUI(),e.authenticate(o)):(e.setState("idle"),e.updateUI())}).catch(o=>{console.error("Initialization error:",o),e.setState("error"),e.showError(o.message)}),this.connector.on("disconnect",()=>{e.setState("idle"),e.updateUI()}),this.connector.on("accountChanged",o=>{o.length>0?e.authenticate(o[0]):(e.setState("idle"),e.updateUI())})},handleLogin:function(){this.setState("connecting"),this.connector.login().then(t=>{if(!t){this.setState("idle");return}console.log("Logged in via:",t),this.setState("connected");const n=this.connector.getAddress();this.authenticate(n)}).catch(t=>{console.error("Login error:",t),this.setState("error"),this.showError(t.message)})},handleDisconnect:function(){this.connector.logout(),this.setState("idle"),this.updateUI()},authenticate:function(t){this.setState("signing"),this.updateUI(),this.fetchNonce(t).then(n=>{const e=n.nonce;this.connector.lastNonce=e;const i=this.createSignMessage(t,e);return this.connector.signMessage(i)}).then(n=>this.sendAuthentication(t,n)).then(n=>{if(n.success)this.setState("authenticated"),this.showSuccess(`Logged in as ${n.username}`),c.walletAuth.redirectOnSuccess?window.location.href=c.walletAuth.redirectOnSuccess:window.location.reload();else throw new Error(n.error||"Authentication failed")}).catch(n=>{console.error("Authentication error:",n),this.setState("error"),this.showError(n.message||"Authentication failed")})},fetchNonce:function(t){const n=c.walletAuth.apiEndpoint;return fetch(`${n}/nonce?wallet_address=${t}`,{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"}}).then(e=>{if(!e.ok)throw new Error("Failed to fetch nonce");return e.json()})},createSignMessage:function(t,n){return`Sign this message to prove ownership of ${t}.

Nonce: ${n}`},sendAuthentication:function(t,n){const e=c.walletAuth.apiEndpoint,i=this.connector.lastNonce,r=this.createSignMessage(t,i);return fetch(e,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({wallet_address:t,signature:n,message:r,nonce:i})}).then(h=>h.ok?h.json():h.json().then(o=>{throw new Error(o.error||"Authentication failed")}))},setState:function(t){this.state=t,s("body").attr("data-wallet-auth-state",t)},updateUI:function(){s(".wallet-auth-container");const t=s(".wallet-auth-login-btn"),n=s(".wallet-auth-disconnect-btn"),e=s(".wallet-auth-status");switch(t.addClass("visually-hidden"),n.addClass("visually-hidden"),this.state){case"idle":t.removeClass("visually-hidden"),e.text("Connect your wallet to login");break;case"connecting":t.removeClass("visually-hidden").prop("disabled",!0),e.text("Connecting to wallet...");break;case"connected":n.removeClass("visually-hidden"),e.text(`Connected: ${this.formatAddress(this.connector.getAddress())}`);break;case"signing":e.text("Please sign the message in your wallet...");break;case"authenticated":e.text("Authentication successful!");break;case"error":t.removeClass("visually-hidden").prop("disabled",!1),e.text("Authentication failed. Please try again.");break}},showError:function(t){a.behaviors.walletAuth.showMessage?a.behaviors.walletAuth.showMessage(t,"error"):alert(t)},showSuccess:function(t){a.behaviors.walletAuth.showMessage?a.behaviors.walletAuth.showMessage(t,"status"):console.log(t)},formatAddress:function(t){return t?`${t.substring(0,6)}...${t.substring(t.length-4)}`:""},detach:function(t,n){this.connector&&this.connector.destroy()}},a.behaviors.walletAuth.showMessage=function(t,n="status"){const e=s(".messages__wrapper",context);if(e.length){const i=s(`<div class="messages messages--${n}">${t}</div>`);e.append(i),setTimeout(()=>i.fadeOut(),5e3)}}})(jQuery,Drupal,drupalSettings)})();
